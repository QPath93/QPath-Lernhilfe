<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard ‚Äì Lernhilfe App</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    /* Grundstyles + Darkmode */
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.light {
      background: linear-gradient(135deg, #e0e7ff, #f0f4ff);
      color: #333;
    }
    body.dark {
      background: linear-gradient(135deg, #111827, #1f2937);
      color: #e5e7eb;
    }

    /* Topbar */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 25px;
      backdrop-filter: blur(6px);
    }
    .theme-toggle {
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      background: rgba(0,0,0,0.1);
      transition: background 0.3s;
    }
    body.dark .theme-toggle { background: rgba(255,255,255,0.1); }
    .btn-logout {
      padding: 10px 16px;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      background: transparent;
      color: #3b82f6;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s;
    }
    .btn-logout:hover { background: #3b82f6; color: #fff; }

    /* √úberschrift */
    .welcome {
      text-align: center;
      margin-top: 20px;
      font-size: 36px;
      font-weight: 600;
      text-decoration: underline green solid;
    }

    /* Aktionen / Filter */
    .actions {
      max-width: 900px;
      margin: 30px auto 0;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      justify-content: space-between;
    }
    .filter-select {
      padding: 12px 16px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      border-radius: 8px;
      border: 2px solid #000;
      background: #fff;
      color: #000;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
    }
    .actions a {
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 8px;
      background: #10b981;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .actions a:hover { opacity: 0.9; }

    /* Grid & Reveal */
    .hilfe-list {
      max-width: 900px;
      margin: 20px auto 40px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }
    .hilfe-entry {
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.6s ease, transform 0.6s ease;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      background: rgba(255,255,255,0.1);
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-radius: 12px;
      height: 260px;
    }
    .hilfe-entry.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Linke Seite */
    .hilfe-left {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    .hilfe-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .hilfe-subject {
      font-size: 14px;
      color: #6b7280;
      margin-bottom: 16px;
    }
    .hilfe-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .hilfe-button {
      padding: 8px 0;
      font-size: 14px;
      border: 2px solid #333;
      border-radius: 20px;
      background: transparent;
      color: #333;
      text-decoration: none;
      text-align: center;
      width: 65%;
      transition: all 0.3s;
    }
    .hilfe-button:hover {
      background: #333;
      color: #fff;
      border-color: #333;
    }
    .hilfe-button.delete-btn {
      border-color: #ef4444;
      color: #ef4444;
    }
    .hilfe-button.delete-btn:hover {
      background: #ef4444;
      color: #fff;
      border-color: #ef4444;
    }
    body.dark .hilfe-button {
      border-color: #e5e7eb;
      color: #e5e7eb;
    }
    body.dark .hilfe-button:hover {
      background: #e5e7eb;
      color: #111;
      border-color: #e5e7eb;
    }
    body.dark .hilfe-button.delete-btn {
      border-color: #ef4444;
      color: #ef4444;
    }
    body.dark .hilfe-button.delete-btn:hover {
      background: #ef4444;
      color: #fff;
      border-color: #ef4444;
    }

    /* QR-Code */
    .qr-preview {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .qr-preview img {
      width: 180px;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
    }
    .qr-download-btn {
      margin-top: 12px;
      width: 180px;
      padding: 10px 0;
      font-size: 16px;
      background: #10b981;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .qr-download-btn:hover { background: #059669; }

    /* Entsperrcode */
    .unlock-info {
      margin-top: 8px;
      font-size: 13px;
      color: #f59e0b;
    }
    body.dark .unlock-info {
      color: #fbbf24;
    }

    @media (max-width: 600px) {
      .hilfe-entry {
        grid-template-columns: 1fr;
        height: auto;
      }
      .hilfe-button, .qr-download-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body class="light">
  <div class="topbar">
    <div id="themeToggle" class="theme-toggle">üåô</div>
    <a href="/logout" class="btn-logout">Logout</a>
  </div>

  <div class="welcome">Willkommen, <%= user.username %>!</div>

  <div class="actions">
    <form id="filterForm" method="GET" action="/dashboard" style="display:flex; gap:12px;">
      <select name="sort" class="filter-select" onchange="filterForm.submit()">
        <option value="date_desc" <%= sort==='date_desc'?'selected':''%>>Neueste zuerst</option>
        <option value="date_asc"  <%= sort==='date_asc'?'selected':''%>>√Ñlteste zuerst</option>
        <option value="title_asc"<%= sort==='title_asc'?'selected':''%>>A‚ÄìZ</option>
        <option value="title_desc"<%= sort==='title_desc'?'selected':''%>>Z‚ÄìA</option>
      </select>
      <select name="subject" class="filter-select" onchange="filterForm.submit()">
        <option value="">Alle F√§cher</option>
        <% allSubjects.forEach(s=>{ %>
          <option value="<%=s%>" <%= subject===s?'selected':''%>><%=s%></option>
        <% }) %>
      </select>
    </form>
    <a href="/lernhilfeerstellen">‚ûï Neue Lernhilfe</a>
  </div>

  <div class="hilfe-list">
    <% hilfen.forEach(hilfe=>{ %>
      <div class="hilfe-entry">
        <div class="hilfe-left">
          <div>
            <div class="hilfe-title"><%=hilfe.title%></div>
            <% if(hilfe.subject){ %>
              <div class="hilfe-subject">Fach: <%=hilfe.subject%></div>
            <% } %>
          </div>
          <div class="hilfe-footer">
            <a href="/hilfe/<%=hilfe._id%>" class="hilfe-button">‚û° √ñffnen</a>
            <a href="/hilfe/<%=hilfe._id%>/bearbeiten" class="hilfe-button">‚úèÔ∏è Bearbeiten</a>
            <form action="/hilfe/<%=hilfe._id%>/loeschen" method="POST"
                  onsubmit="return confirm('Bist du sicher, dass du diese Lernhilfe l√∂schen m√∂chtest?');">
              <button type="submit" class="hilfe-button delete-btn">üóëÔ∏è L√∂schen</button>
            </form>
          </div>
          <% 
            const codes = hilfe.hilfen
              .filter(h=>h.locked && h.lockCode)
              .map(h=>h.lockCode);
          %>
          <% if(codes.length>0){ %>
            <div class="unlock-info">
              Entsperrcode<%= codes.length>1 ? 's' : '' %>: <%= codes.join(', ') %>
            </div>
          <% } %>
        </div>
        <div class="qr-preview">
          <img id="qr-img-<%=hilfe._id%>" alt="QR-Code">
          <button class="qr-download-btn" onclick="downloadQR('<%=hilfe._id%>')">üì• QR-Code</button>
        </div>
      </div>
    <% }) %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    // Dark/Light Mode + Icon
    const toggle = document.getElementById('themeToggle'),
          body   = document.body;
    function setTheme(t){
      if(t==='dark'){
        body.classList.replace('light','dark');
        toggle.textContent = '‚òÄÔ∏è';
      } else {
        body.classList.replace('dark','light');
        toggle.textContent = 'üåô';
      }
      localStorage.setItem('theme', t);
    }
    toggle.addEventListener('click', ()=> setTheme(body.classList.contains('light')?'dark':'light'));
    setTheme(localStorage.getItem('theme')||'light');

    // QR-Code generieren & setzen
    <% hilfen.forEach(hilfe=>{ 
      const url = `${req.protocol}://${req.get('host')}/hilfe/${hilfe._id}`;
    %>
      QRCode.toDataURL('<%=url%>').then(dataUrl=>{
        const img = document.getElementById('qr-img-<%=hilfe._id%>');
        img.src = dataUrl;
        img.dataset.url = dataUrl;
      });
    <% }) %>
    function downloadQR(id){
      const img  = document.getElementById('qr-img-'+id);
      const link = document.createElement('a');
      link.href  = img.dataset.url;
      link.download = 'qr-code.png';
      link.click();
    }

    // Reveal-on-scroll
    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelectorAll('.hilfe-entry').forEach(el=>{
        const obs = new IntersectionObserver((entries,o)=>{
          if(entries[0].isIntersecting){
            el.classList.add('visible');
            o.disconnect();
          }
        },{threshold:0.15});
        obs.observe(el);
      });
    });
  </script>
</body>
</html>